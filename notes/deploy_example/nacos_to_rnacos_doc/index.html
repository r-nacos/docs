<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    
    <title>r-nacos | Hi，终于等到你</title>
    <meta name="description" content="r-nacos doc">
    <meta name="generator" content="VitePress v1.3.2">
    <link rel="preload stylesheet" href="/docs/assets/style.BFzrW-qH.css" as="style">
    
    <script type="module" src="/docs/assets/app.DoLV5Ven.js"></script>
    <link rel="preload" href="/docs/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/docs/assets/chunks/theme.CYT-QnkH.js">
    <link rel="modulepreload" href="/docs/assets/chunks/framework.YgLIuCY9.js">
    <link rel="modulepreload" href="/docs/assets/notes_deploy_example_nacos_to_rnacos_doc_index.md.BzWCIRBu.lean.js">
    <link rel="shortcut icon" href="/docs//favicon.ico">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <script id="register-sw">"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js");</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no,shrink-to-fit=no">
    <meta name="keywords" content="r-nacos,nacos,rnacos">
    <script async src="https://hm.baidu.com/hm.js?afa135946ba7fb33d69bea1f370b905c"></script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar has-sidebar top" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-ab179fa1><a class="title" href="/docs/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/docs/logo.png" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>r-nacos</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs/" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs/notes/faq/" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>常见问题</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/docs/notes/change/" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>更新日志</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://www.bestreven.top/rnacos/" target="_blank" rel="noreferrer" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>控制台演示</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/r-nacos/r-nacos" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/r-nacos/r-nacos" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b7550ba0><!----><div class="items" data-v-b7550ba0><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/intro/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/quick_started/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>快速开始</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/cluster_deploy/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>集群部署</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/env_config/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>运行参数说明</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/performance/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>性能与容量说明</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/version_describe/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>版本说明</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/architecture/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>架构</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/faq/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>常见问题</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 collapsible has-active" data-v-c40bc020 data-v-b7550ba0><div class="item" role="button" tabindex="0" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><h2 class="text" data-v-b7550ba0>部署样例</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b7550ba0><span class="vpi-chevron-right caret-icon" data-v-b7550ba0></span></div></div><div class="items" data-v-b7550ba0><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/deploy_example/linux_deploy/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>单机部署</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/deploy_example/linux_systemd_deploy/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>使用systemd部署r-nacos</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/deploy_example/docker_cluster_deploy/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>集群部署</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/docs/notes/deploy_example/nacos_to_rnacos_doc/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>如何平稳地从nacos迁移到r-nacos？</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>目录</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _docs_notes_deploy_example_nacos_to_rnacos_doc_" data-v-39a288b8><div><h2 id="_1-引言" tabindex="-1">1. 引言 <a class="header-anchor" href="#_1-引言" aria-label="Permalink to &quot;1. 引言&quot;">​</a></h2><p>很多同学了解r-nacos特性后最开始只将r-nacos用于开发测试环境。</p><p>经过一段时间的使用后，部分同学有打算生产环境也从nacos迁移到r-nacos。</p><p>一些之前使用nacos服务的同学了解r-nacos后打算从nacos迁移到r-nacos。</p><p>那么如何平衡地从nacos迁移到r-nacos呢？</p><p><a href="https://github.com/nacos-group/r-nacos" target="_blank" rel="noreferrer">r-nacos</a> 简介：</p><blockquote><p>r-nacos是一个用rust实现的nacos服务。相较于java nacos来说，是一个提供相同功能，启动更快、占用系统资源更小（初始内存小于10M）、性能更高、运行更稳定的服务。</p><p>r-nacos设计上完全兼容最新版本nacos面向client sdk 的协议（包含1.x的http OpenApi，和2.x的grpc协议）, 支持使用nacos服务的应用平迁到 r-nacos。</p></blockquote><h2 id="_2-迁移计划" tabindex="-1">2. 迁移计划 <a class="header-anchor" href="#_2-迁移计划" aria-label="Permalink to &quot;2. 迁移计划&quot;">​</a></h2><h3 id="_2-1-待迁移内容分析" tabindex="-1">2.1 待迁移内容分析 <a class="header-anchor" href="#_2-1-待迁移内容分析" aria-label="Permalink to &quot;2.1 待迁移内容分析&quot;">​</a></h3><p>迁移的目标已明确，在设计迁移计划前，我们需要先分析待迁移的数据。</p><p><img src="/docs/assets/20240718235044.BJpPydPG.png" alt=""></p><p>从nacos迁移到r-nacos主要涉及4类数据：</p><ol><li>nacos鉴权用户数据</li><li>命名空间数据</li><li>配置数据</li><li>服务实例数据</li></ol><p>nacos用户数据、命名空间数据与配置数据是持久化数据，需要事先完成设置与迁移。 服务实例数据是动态数据，切换后应该会自动注册，不需要事先迁移。</p><h3 id="_2-2-迁移阶段与步骤" tabindex="-1">2.2 迁移阶段与步骤 <a class="header-anchor" href="#_2-2-迁移阶段与步骤" aria-label="Permalink to &quot;2.2 迁移阶段与步骤&quot;">​</a></h3><p>我们可以把迁移分为3个阶段：</p><ol><li>迁移前准备阶段；</li><li>迁移阶段；</li><li>迁移后收尾阶段；</li></ol><p>一、迁移前准备</p><p><img src="/docs/assets/20240719000940.AaqeeIsA.png" alt=""></p><ol><li>部署r-nacos,用于迁移前做数据迁移与数据录入。（如果nacos与r-nacos在同一台机器，可以用临时端口号启动r-nacos，等迁移时再更新端口号重启）</li><li>在r-nacos控制台录入应用依赖的用户信息，完成用户数据初始化。</li><li>在r-nacos控制台录入命名空间数据；</li><li>从nacos控制台按命名空间全量导出数据（每个命名空间会导出一个文件）；然后分别把这部分配置数据通过r-nacos控制台导入对应命名空间中，完成配置数据迁移。</li></ol><p>二、迁移中</p><p>数据迁移完成后即可开始切流迁移。</p><p><img src="/docs/assets/20240719002254.u4Gy80V3.png" alt=""></p><p>把应用请求流量切到r-nacos中，这一步不同的场景需要用不同的处理方式：</p><blockquote><ol><li>应用直接请求nacos服务场景：r-nacos需要和nacos在同一个机器替换它；需要先关闭nacos，再把r-nacos的端口改成原nacos端口启动，完成切换。</li><li>应用请求nginx后反向代理到nacos场景：更新nginx配置，把nacos反向代理地址更新为r-nacos地址，然后重新增加配置完成切换。</li></ol></blockquote><p>切流迁移完成后，注意观察应用与r-nacos的表现是否符合预期。</p><p>注意：就算目标是要开启鉴权，这个阶段r-naocs也不要启接口鉴权 (<code>RNACOS_ENABLE_OPEN_API_AUTH=false</code>)，以防应用使用原nacos分配旧token请求被拦截。</p><p>三、迁移后收尾</p><p><img src="/docs/assets/20240719005524.LT0QBIL-.png" alt=""></p><p>完成迁移稳定运行一小段时间后，可以将nacos移除，只保留r-nacos。</p><p>如果需要对接口开启鉴权，则走以下操作：</p><blockquote><p>a) 等应用旧token都过期(默认过期时间是5小时)都重新从r-nacos获取新token之后，再开启接口鉴权配置重启r-nacos（r-nacos可以秒级重启，应用几乎无感）。 b) 也可以分批重启应用强行其使用r-nacos token,之后再开启接口鉴权配置重启r-nacos。</p></blockquote><p>至此完成从nacos迁移到r-nacos</p><h2 id="_3-迁移案例" tabindex="-1">3. 迁移案例 <a class="header-anchor" href="#_3-迁移案例" aria-label="Permalink to &quot;3. 迁移案例&quot;">​</a></h2><p>前面讲的是迁移操作步骤可能比较抽象，这里再补充两个具体迁移场景案例让读者更有体感。</p><h3 id="_3-1-应用服务直链单节点nacos的场景迁移方案" tabindex="-1">3.1 应用服务直链单节点nacos的场景迁移方案 <a class="header-anchor" href="#_3-1-应用服务直链单节点nacos的场景迁移方案" aria-label="Permalink to &quot;3.1 应用服务直链单节点nacos的场景迁移方案&quot;">​</a></h3><p>部署图：</p><p><img src="/docs/assets/20240719090037.CM9xjR00.png" alt=""></p><p>nacos持久化内容:</p><p><img src="/docs/assets/20240721224800.B5Mb9MBG.png" alt=""></p><p>nacos使用情况：</p><blockquote><ol><li>在10.0.24.9部署一台nacos，使用默认端口号8848,8948提供服务；</li><li>nacos上设置两个命名空间pre,prod分别对预发、生产环境提供服务</li><li>有3个应用，每个应用2个实例使用nacos服务； 总共两套环境，其中一套环境共有3个配置文件，3个服务，6个实例；</li><li>应用使用的用户名：<code>xxx_app_id</code> ,密码: <code>a07a6deb5e56</code></li></ol></blockquote><p>目标： 在同一台机器中部署r-nacos替换nacos提供服务，使用<a href="https://r-nacos.github.io/docs/notes/deploy_example/linux_systemd_deploy/" target="_blank" rel="noreferrer">systemd方式部署</a></p><h4 id="_3-1-1-迁移步骤——迁移前" tabindex="-1">3.1.1 迁移步骤——迁移前 <a class="header-anchor" href="#_3-1-1-迁移步骤——迁移前" aria-label="Permalink to &quot;3.1.1 迁移步骤——迁移前&quot;">​</a></h4><p><strong>步骤1</strong> 、 在10.0.24.9使用临时端口8858部署r-nacos。 这里假设使用linux systemd方式部署。具体部署方式参考r-nacos说明文档，这里不展开。 关键配置项如下：</p><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># r-nacos监听http端口，这里使用临时端口8858，后面切流时调整回来</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RNACOS_HTTP_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=8858</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># r-nacos监听grpc端口,grpc端口这里不配置，默认值：HTTP端口+1000</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># RNACOS_GRPC_PORT=9858</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># r-nacos独立控制台端口,这个没有端口冲突，可以直接使用正式端口</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RNACOS_HTTP_CONSOLE_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=10848</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RNACOS_ENABLE_OPEN_API_AUTH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=false</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注：如果是docker启动方式，配置端口不用改，只需改对应对外映射的端口号即可</p><p><strong>步骤2</strong> 、初始化用户信息 访问<code>http://10.0.24.9:10848/rnacos/</code>进入控制台。 增加应用依赖用户，用户名：<code>xxx_app_id</code> ,密码: `a07a6deb5e56</p><p><img src="/docs/assets/20240721225717.BLwqj9Zy.png" alt=""></p><p><strong>步骤3</strong>、初始化命名空间</p><p>初始化命名空间 pre、prod</p><p><img src="/docs/assets/20240721225844.Dr5K9ZDj.png" alt=""></p><p><strong>步骤4</strong>、迁移配置信息</p><ol><li>从nacos导出配置</li></ol><p><img src="/docs/assets/20240721230843.BD3JDO48.png" alt=""></p><p>分别导出pre、prod命名空间下的配置</p><p><img src="/docs/assets/20240721230943.C2Bk9i5X.png" alt=""></p><p>导出的文件名格式为：<code>nacos_config_export_20240721230938.zip</code></p><p>注意：每次导出后记得改下文件名增加命名空间标记，以防导入时选错文件。</p><ol start="2"><li>把配置导入r-nacos 分别把上一步nacos导出的配置文件包导出到r-nacos pre、prod命名空间下的配置。</li></ol><p>a) 进入r-nacos控制台-&gt;配置列表页,选择对应命名空间</p><p><img src="/docs/assets/20240721231711.BL7lZurI.png" alt=""></p><p>b) 上传导入配置文件</p><p><img src="/docs/assets/20240721231944.DaFNMvqj.png" alt=""> 导入后： <img src="/docs/assets/20240721232033.Z_xiU6nU.png" alt=""></p><p>上面图中操作的是pre命名空间，prod命名空间也操作一遍，这里不展开。</p><h4 id="_3-1-2-迁移步骤——迁移中" tabindex="-1">3.1.2 迁移步骤——迁移中 <a class="header-anchor" href="#_3-1-2-迁移步骤——迁移中" aria-label="Permalink to &quot;3.1.2 迁移步骤——迁移中&quot;">​</a></h4><p><strong>步骤5</strong>、 完成数据初始化后关闭r-nacos，先把临时端口更新正式端口，方便后面可以直接启动r-nacos。</p><p>关闭r-nacos服务</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>systemctl stop rnacos</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>关键配置项如下：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>properties</span></span>
<span class="line"><span># r-nacos监听http端口</span></span>
<span class="line"><span>RNACOS_HTTP_PORT=8848</span></span>
<span class="line"><span># r-nacos监听grpc端口,grpc端口这里不配置，默认值：HTTP端口+1000</span></span>
<span class="line"><span># RNACOS_GRPC_PORT=9848</span></span>
<span class="line"><span># r-nacos独立控制台端口</span></span>
<span class="line"><span>RNACOS_HTTP_CONSOLE_PORT=10848</span></span>
<span class="line"><span># 切换过程中不开启接口鉴权</span></span>
<span class="line"><span>RNACOS_ENABLE_OPEN_API_AUTH=false</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>步骤6</strong>、关闭nacos</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 切换到nacos目录，执行以下命名关闭nacos</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./bin/shutdown.sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>步骤7</strong>、启动r-nacos</p><p>配置信息在关闭nacos前已准备好，直接启动r-nacos服务：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rnacos</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_3-1-3-迁移步骤——迁移后" tabindex="-1">3.1.3 迁移步骤——迁移后 <a class="header-anchor" href="#_3-1-3-迁移步骤——迁移后" aria-label="Permalink to &quot;3.1.3 迁移步骤——迁移后&quot;">​</a></h4><p><strong>步骤8</strong>、切流完成，观察应用与r-nacos确认其是否正常工作。</p><p>应用服务可通过上游应用页面访问看看是否正常。 r-nacos可能通过监控页面查询其是否被应用访问。</p><p><img src="/docs/assets/20240722075241.DkCwAQuX.png" alt=""></p><p><strong>步骤9</strong>、开启r-nacos接口鉴权 （可选）</p><p>切流完成后过5个小时之后，开启r-nacos接口鉴权。</p><p>关键配置项如下：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>properties</span></span>
<span class="line"><span># r-nacos监听http端口</span></span>
<span class="line"><span>RNACOS_HTTP_PORT=8848</span></span>
<span class="line"><span># r-nacos监听grpc端口,grpc端口这里不配置，默认值：HTTP端口+1000</span></span>
<span class="line"><span># RNACOS_GRPC_PORT=9848</span></span>
<span class="line"><span># r-nacos独立控制台端口</span></span>
<span class="line"><span>RNACOS_HTTP_CONSOLE_PORT=10848</span></span>
<span class="line"><span># 开启接口鉴权</span></span>
<span class="line"><span>RNACOS_ENABLE_OPEN_API_AUTH=true</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>重启r-nacos服务:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rnacos</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>至此，完成从nacos到r-nacos的迁移</p><h3 id="_3-2-应用服务通过nginx链接nacos场景迁移方案" tabindex="-1">3.2 应用服务通过nginx链接nacos场景迁移方案 <a class="header-anchor" href="#_3-2-应用服务通过nginx链接nacos场景迁移方案" aria-label="Permalink to &quot;3.2 应用服务通过nginx链接nacos场景迁移方案&quot;">​</a></h3><p>部署图：</p><p><img src="/docs/assets/20240722005450.DJVb2n4-.png" alt=""></p><p>nacos内容和前一个场景一样，部署时中间多用了nginx代理提供服务。</p><p>通过nginx链接nacos，那么切换时只需要把nginx配置中原nacos地址切换为r-naocs地址，然后通过 <code>nginx -s reload</code> 重新加载配置规则即可完成切流。</p><h4 id="_3-2-1-迁移步骤——迁移前" tabindex="-1">3.2.1 迁移步骤——迁移前 <a class="header-anchor" href="#_3-2-1-迁移步骤——迁移前" aria-label="Permalink to &quot;3.2.1 迁移步骤——迁移前&quot;">​</a></h4><p>步骤和前一个场景第1、2、3、4步一致，这里不展开。</p><h4 id="_3-2-2-迁移步骤——迁移中" tabindex="-1">3.2.2 迁移步骤——迁移中 <a class="header-anchor" href="#_3-2-2-迁移步骤——迁移中" aria-label="Permalink to &quot;3.2.2 迁移步骤——迁移中&quot;">​</a></h4><p><strong>步骤5</strong>、更新nginx配置，把原nacos地址切换为r-naocs地址。</p><p>原nginx配置</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># nacos http</span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>    listen       8848;</span></span>
<span class="line"><span>    listen  [::]:8848;</span></span>
<span class="line"><span>    server_name  localhost;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location /nacos {</span></span>
<span class="line"><span>        proxy_set_header Host $proxy_host;</span></span>
<span class="line"><span>        proxy_pass http://10.0.24.9:8848;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># nacos grpc</span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>    listen       9848;</span></span>
<span class="line"><span>    listen  [::]:9848;</span></span>
<span class="line"><span>    server_name  localhost;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location /nacos {</span></span>
<span class="line"><span>        grpc_pass grpc://10.0.24.9:9848;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>更新后的nginx配置</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># nacos http</span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>    listen       8848;</span></span>
<span class="line"><span>    listen  [::]:8848;</span></span>
<span class="line"><span>    server_name  localhost;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location /nacos {</span></span>
<span class="line"><span>        proxy_set_header Host $proxy_host;</span></span>
<span class="line"><span>        proxy_pass http://10.0.24.9:8858;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># nacos grpc</span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>    listen       9848;</span></span>
<span class="line"><span>    listen  [::]:9848;</span></span>
<span class="line"><span>    server_name  localhost;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location /nacos {</span></span>
<span class="line"><span>        grpc_pass grpc://10.0.24.9:9858;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>执行<code>nginx -s reload</code> 重新加载配置规则即可完成切流。</p><p>切换后：</p><p><img src="/docs/assets/20240722075815.CBFoBxfI.png" alt=""></p><h4 id="_3-2-3-迁移步骤——迁移后" tabindex="-1">3.2.3 迁移步骤——迁移后 <a class="header-anchor" href="#_3-2-3-迁移步骤——迁移后" aria-label="Permalink to &quot;3.2.3 迁移步骤——迁移后&quot;">​</a></h4><p>步骤和前一个场景第8、9步一致，这里不展开。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>对于nacos迁移到r-nacos，分析待迁移数据项与划分好迁移各个阶段需要做的事项，可以设计出合适的迁移方案。</p><p>迁移可分在迁移前、迁移中、迁移后三个阶段，本文结合样例场景给出了较具体操作步骤。</p><p>如果上面的案例和自己的实际情况一致，可以考虑应用请求nacos前加一层nginx反向代理，之后再按案例2迁移即可。</p><hr><p>时间: 2024-07-22</p><p>作者: <a href="https://github.com/heqingpan" target="_blank" rel="noreferrer">heqingpan</a></p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><!----><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>上次更新: <time datetime="2024-08-17T00:59:03.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/docs/notes/deploy_example/docker_cluster_deploy/" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>上一篇</span><span class="title" data-v-e257564d>集群部署</span><!--]--></a></div><div class="pager" data-v-e257564d><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>Released under the MIT License.</p><p class="copyright" data-v-e315a0ad>Copyright © 2024 r-nacos</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"index.md\":\"yBDYs3DN\",\"notes_architecture_index.md\":\"C0sw_EKH\",\"notes_change_index.md\":\"D9ONtV6I\",\"notes_cluster_deploy_index.md\":\"Co__6suq\",\"notes_deploy_example_docker_cluster_deploy_index.md\":\"DQeiIgV6\",\"notes_deploy_example_linux_deploy_index.md\":\"Dedl5eDm\",\"notes_deploy_example_linux_systemd_deploy_index.md\":\"DOVMLo-B\",\"notes_deploy_example_nacos_to_rnacos_doc_index.md\":\"BzWCIRBu\",\"notes_env_config_index.md\":\"HbDDwxJH\",\"notes_faq_index.md\":\"z_psD1N-\",\"notes_intro_index.md\":\"CGBtoy-Q\",\"notes_performance_index.md\":\"ByrAKjXN\",\"notes_quick_started_index.md\":\"VEKmEP4m\",\"notes_version_describe_index.md\":\"DrbNU89q\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"r-nacos\",\"titleTemplate\":\"Hi，终于等到你\",\"description\":\"r-nacos doc\",\"base\":\"/docs/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"lastUpdatedText\":\"上次更新\",\"returnToTopLabel\":\"返回顶部\",\"search\":{\"provider\":\"local\"},\"logo\":\"/logo.png\",\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"常见问题\",\"link\":\"/notes/faq/\"},{\"text\":\"更新日志\",\"link\":\"/notes/change/\"},{\"text\":\"控制台演示\",\"link\":\"https://www.bestreven.top/rnacos/\"}],\"sidebar\":{\"/\":[{\"text\":\"简介\",\"link\":\"/notes/intro/\"},{\"text\":\"快速开始\",\"link\":\"/notes/quick_started/\"},{\"text\":\"集群部署\",\"link\":\"/notes/cluster_deploy/\"},{\"text\":\"运行参数说明\",\"link\":\"/notes/env_config/\"},{\"text\":\"性能与容量说明\",\"link\":\"/notes/performance/\"},{\"text\":\"版本说明\",\"link\":\"/notes/version_describe/\"},{\"text\":\"架构\",\"link\":\"/notes/architecture/\"},{\"text\":\"常见问题\",\"link\":\"/notes/faq/\"},{\"text\":\"部署样例\",\"collapsed\":false,\"items\":[{\"text\":\"单机部署\",\"link\":\"/notes/deploy_example/linux_deploy/\"},{\"text\":\"使用systemd部署r-nacos\",\"link\":\"/notes/deploy_example/linux_systemd_deploy/\"},{\"text\":\"集群部署\",\"link\":\"/notes/deploy_example/docker_cluster_deploy/\"},{\"text\":\"如何平稳地从nacos迁移到r-nacos？\",\"link\":\"/notes/deploy_example/nacos_to_rnacos_doc/\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/r-nacos/r-nacos\"}],\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2024 r-nacos\"},\"outline\":{\"level\":[1,6],\"label\":\"目录\"},\"outlineTitle\":\"当前页大纲\"},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>